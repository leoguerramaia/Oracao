<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.2/firebase-app.js";
  import { getFirestore, collection, addDoc, getDocs, query, where } from "https://www.gstatic.com/firebasejs/10.7.2/firebase-firestore.js";

  const firebaseConfig = {
    apiKey: "AIzaSyATVaYFF3Ho47Vc4bB0BOy7Q2NKLAqSHXQ",
    authDomain: "pedidosoracao-5226e.firebaseapp.com",
    projectId: "pedidosoracao-5226e",
    storageBucket: "pedidosoracao-5226e.firebasestorage.app",
    messagingSenderId: "1036424775005",
    appId: "1:1036424775005:web:e07fb3c31ff94854c894b4",
    measurementId: "G-DP0CCC7BGC"
  };

  const app = initializeApp(firebaseConfig);
  const db = getFirestore(app);

  document.getElementById("formCadastro").addEventListener("submit", async function(e){
    e.preventDefault();

    const email = document.getElementById("email").value.trim().toLowerCase();

    // üîé Verifica se j√° existe e-mail cadastrado
    const q = query(collection(db, "cadastrosUsuarios"), where("email", "==", email));
    const snap = await getDocs(q);
    if(!snap.empty){
      document.getElementById("emailErro").style.display = "block";
      return;
    } else {
      document.getElementById("emailErro").style.display = "none";
    }

    // Confere senha
    const senha = document.getElementById("senha").value;
    const confirma = document.getElementById("confirmaSenha").value;
    if(senha !== confirma){
      alert("‚ùå As senhas n√£o coincidem!");
      return;
    }

    // Foto
    let fotoBase64 = "";
    const fotoFile = document.getElementById("foto").files[0];
    if(fotoFile){
      fotoBase64 = await new Promise(resolve=>{
        const reader = new FileReader();
        reader.onload = ev => resolve(ev.target.result);
        reader.readAsDataURL(fotoFile);
      });
    }

    const novoCadastro = {
      nome: document.getElementById("nome").value.trim(),
      apelido: document.getElementById("apelido").value.trim(),
      sexo: document.getElementById("sexo").value,
      telefone: document.getElementById("telefone").value.trim(),
      email: email,
      cep: document.getElementById("cep").value.trim(),
      rua: document.getElementById("rua").value.trim(),
      numero: document.getElementById("numero").value.trim(),
      complemento: document.getElementById("complemento").value.trim(),
      bairro: document.getElementById("bairro").value.trim(),
      cidade: document.getElementById("cidade").value.trim(),
      estado: document.getElementById("estado").value.trim(),
      visita: document.getElementById("visita").value,
      maps: document.getElementById("maps").value.trim(),
      senha: senha,
      foto: fotoBase64
    };

    try{
      await addDoc(collection(db, "cadastrosUsuarios"), novoCadastro);
      alert("‚úÖ Cadastro realizado com sucesso!");
      window.location.href = "index.html";
    }catch(err){
      console.error(err);
      alert("‚ùå Erro ao salvar cadastro.");
    }
  });
</script>
