<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <title>Cadastro - Pedidos de Ora√ß√£o</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root{
      --bg:#fff7f2;
      --card:#ffffff;
      --text:#2c3e50;
      --muted:#6b7b8c;
      --primary:#b22222;
      --primary-hov:#800000;
      --accent:#ff4500;
      --ring:rgba(178,34,34,.35);
    }
    body{margin:0;font-family:system-ui, Arial, sans-serif;background:var(--bg);color:var(--text);}
    header{background:var(--primary);color:#ffd700;padding:20px;text-align:center;}
    header h1{margin:0;font-size:24px;}
    .container{max-width:720px;margin:32px auto;padding:0 16px;}
    .card{background:var(--card);border-radius:14px;padding:24px;box-shadow:0 12px 30px rgba(0,0,0,.08);}
    form{display:flex;flex-direction:column;gap:12px}
    label{font-weight:600;margin-top:8px}
    label .required{color:var(--primary);margin-left:4px}
    input, select, button{width:100%;padding:12px 14px;border-radius:10px;font-size:15px;border:1px solid #e1e5ea;outline:none;background:#fff;}
    input:focus, select:focus{border-color:var(--primary);box-shadow:0 0 0 4px var(--ring)}
    .erro{color:var(--primary);font-size:13px;display:none}
    .msg{color:var(--muted);font-size:13px;margin-top:-6px}
    .preview{font-size:14px;margin-top:6px}
    .preview a{color:var(--primary);text-decoration:none;display:flex;align-items:center;gap:6px}
    .preview img{width:20px;height:20px}
    .senha-container{position:relative;display:flex;align-items:center;}
    .senha-container input{width:100%;padding-right:40px;}
    .toggle-senha{position:absolute;right:10px;cursor:pointer;font-size:18px;color:var(--muted);}
    .obrigatorio{font-size:13px;color:var(--muted);margin-top:4px;}
    button{border:none;font-weight:700;cursor:pointer;transition:.3s}
    .btn-main{background:var(--primary);color:#fff}
    .btn-main:hover{background:var(--primary-hov)}
    .row{display:flex;gap:12px;flex-wrap:wrap}
    .row>div{flex:1;min-width:150px}
    .foto-upload{display:flex;flex-direction:column;align-items:center;gap:8px;margin-bottom:16px;}
    .foto-preview{width:100px;height:100px;border-radius:50%;border:2px solid var(--primary);object-fit:cover;display:none;}
  </style>
</head>
<body>
  <header><h1>üìù Cadastro</h1></header>
  <main class="container">
    <section class="card">
      <form id="formCadastro" action="javascript:void(0);">
        <!-- Foto -->
        <div class="foto-upload">
          <img id="fotoPreview" class="foto-preview" alt="Pr√©via da foto">
          <input type="file" id="foto" accept="image/*" capture="environment">
        </div>

        <label for="nome">Nome:<span class="required">*</span></label>
        <input type="text" id="nome" required>

        <label for="apelido">Como Gosta de Ser Chamado:</label>
        <input type="text" id="apelido" placeholder="Ex: Leo, Mariazinha, Pastor Jo√£o">

        <label for="sexo">Sexo:<span class="required">*</span></label>
        <select id="sexo" required>
          <option value="">Selecione...</option>
          <option value="MASCULINO">Masculino</option>
          <option value="FEMININO">Feminino</option>
        </select>

        <label for="telefone">Telefone (DDD + n√∫mero):<span class="required">*</span></label>
        <input type="tel" id="telefone" placeholder="11987654321" required>
        <div id="whatsLink" class="preview"></div>

        <label for="email">E-mail:<span class="required">*</span></label>
        <input type="email" id="email" required>
        <div id="emailErro" class="erro">‚ùå J√° existe um cadastro com este e-mail.</div>

        <label for="cep">CEP:</label>
        <input type="text" id="cep" maxlength="8" placeholder="Somente n√∫meros" onblur="buscarCEP()">
        <div id="cepErro" class="erro"></div>

        <label for="rua">Rua:</label>
        <input type="text" id="rua" disabled>

        <div class="row">
          <div><label for="numero">N√∫mero:</label><input type="text" id="numero"></div>
          <div><label for="complemento">Complemento:</label><input type="text" id="complemento"></div>
        </div>

        <label for="bairro">Bairro:</label><input type="text" id="bairro" disabled>
        <label for="cidade">Cidade:</label><input type="text" id="cidade" disabled>
        <label for="estado">Estado:</label><input type="text" id="estado" disabled>

        <label for="visita">Aceita Visita?<span class="required">*</span></label>
        <select id="visita" required>
          <option value="">Selecione...</option>
          <option value="SIM">Sim</option>
          <option value="N√ÉO">N√£o</option>
        </select>

        <label for="maps">URL do Google Maps:</label>
        <input type="url" id="maps" placeholder="Cole aqui a URL do Maps" oninput="previewMaps()">
        <div id="mapsPreview" class="preview"></div>

        <label for="senha">Senha:<span class="required">*</span></label>
        <div class="senha-container">
          <input type="password" id="senha" required>
          <span class="toggle-senha" onclick="toggleSenha('senha', this)">üëÅÔ∏è</span>
        </div>

        <label for="confirmaSenha">Confirmar Senha:<span class="required">*</span></label>
        <div class="senha-container">
          <input type="password" id="confirmaSenha" required>
          <span class="toggle-senha" onclick="toggleSenha('confirmaSenha', this)">üëÅÔ∏è</span>
        </div>

        <p class="obrigatorio">‚ö†Ô∏è Os campos marcados com * s√£o obrigat√≥rios.</p>
        <button type="submit" class="btn-main" id="btnCadastrar">‚úÖ Finalizar Cadastro</button>
      </form>
    </section>
  </main>

  <!-- Firebase compat (evita problemas de ES Modules) -->
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore-compat.js"></script>

  <script>
    // --- Config do seu projeto Firebase ---
    const firebaseConfig = {
      apiKey: "AIzaSyATVaYFF3Ho47Vc4bB0BOy7Q2NKLAqSHXQ",
      authDomain: "pedidosoracao-5226e.firebaseapp.com",
      projectId: "pedidosoracao-5226e",
      storageBucket: "pedidosoracao-5226e.firebasestorage.app",
      messagingSenderId: "1036424775005",
      appId: "1:1036424775005:web:e07fb3c31ff94854c894b4",
      measurementId: "G-DP0CCC7BGC"
    };

    // Inicializa Firebase + Firestore
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();

    // üîé Auto-diagn√≥stico r√°pido do Firestore ao carregar a p√°gina
    (async function smokeTest(){
      try{
        const ref = await db.collection("__ping").add({ t: Date.now() });
        // tenta remover para n√£o sujar a base (ignora erro de delete)
        try { await db.collection("__ping").doc(ref.id).delete(); } catch(_) {}
        console.log("[Firestore] OK: escrita liberada.");
      }catch(err){
        console.error("[Firestore] Falha na escrita:", err);
        alert("‚ùå O Firestore est√° bloqueando a grava√ß√£o.\n\nDetalhes: " + (err?.code || "") + " - " + (err?.message || err) + "\n\nDica: ajuste as regras em Firestore > Rules para permitir escrita temporariamente durante o teste.");
      }
    })();

    // ==== UI helpers ====
    function toggleSenha(id, el){
      const input = document.getElementById(id);
      if(input.type === "password"){ input.type = "text"; el.textContent = "üôà"; }
      else{ input.type = "password"; el.textContent = "üëÅÔ∏è"; }
    }
    window.toggleSenha = toggleSenha;

    async function buscarCEP(){
      const cep = document.getElementById("cep").value.replace(/\D/g,'');
      const erroDiv = document.getElementById("cepErro");
      if(cep.length !== 8) return;
      try{
        const resp = await fetch(`https://viacep.com.br/ws/${cep}/json/`);
        const dados = await resp.json();
        if(dados.erro){
          erroDiv.style.display = "block";
          erroDiv.innerText = "‚ùå CEP n√£o encontrado. Preencha manualmente.";
          habilitarEndereco(true);
        } else {
          erroDiv.style.display = "none";
          document.getElementById("rua").value = dados.logradouro || "";
          document.getElementById("bairro").value = dados.bairro || "";
          document.getElementById("cidade").value = dados.localidade || "";
          document.getElementById("estado").value = dados.uf || "";
          habilitarEndereco(false);
        }
      }catch{
        erroDiv.style.display = "block";
        erroDiv.innerText = "‚ùå Erro ao buscar CEP. Preencha manualmente.";
        habilitarEndereco(true);
      }
    }
    window.buscarCEP = buscarCEP;

    function habilitarEndereco(habilitar){
      ["rua","bairro","cidade","estado"].forEach(id=> document.getElementById(id).disabled = !habilitar);
    }

    // WhatsApp preview
    document.getElementById("telefone").addEventListener("input", ()=>{
      const tel = document.getElementById("telefone").value.replace(/\D/g,'');
      const whatsDiv = document.getElementById("whatsLink");
      if(/^\d{10,11}$/.test(tel)){
        whatsDiv.innerHTML = `<a href="https://wa.me/55${tel}" target="_blank">üí¨ Conversar no WhatsApp</a>`;
      } else whatsDiv.innerHTML = "";
    });

    function previewMaps(){
      const url = document.getElementById("maps").value.trim();
      const div = document.getElementById("mapsPreview");
      div.innerHTML = url ? `<a href="${url}" target="_blank">üìç Abrir localiza√ß√£o</a>` : "";
    }
    window.previewMaps = previewMaps;

    // Foto preview
    const fotoInput = document.getElementById("foto");
    const fotoPreview = document.getElementById("fotoPreview");
    fotoInput?.addEventListener("change", e=>{
      const file = e.target.files[0];
      if(file){
        const reader = new FileReader();
        reader.onload = ev=>{
          fotoPreview.src = ev.target.result;
          fotoPreview.style.display = "block";
        };
        reader.readAsDataURL(file);
      }
    });

    // ==== SUBMIT ====
    const form = document.getElementById("formCadastro");
    const btn = document.getElementById("btnCadastrar");

    form.addEventListener("submit", async (e)=>{
      e.preventDefault();

      // normaliza telefone (s√≥ d√≠gitos)
      const telEl = document.getElementById("telefone");
      telEl.value = telEl.value.replace(/\D/g, "");

      if(!form.checkValidity()){
        form.reportValidity();
        return;
      }

      btn.disabled = true; btn.textContent = "Salvando...";

      // Verifica e-mail duplicado
      const email = document.getElementById("email").value.trim().toLowerCase();
      try{
        const snap = await db.collection("cadastrosUsuarios").where("email","==",email).get();
        if(!snap.empty){
          document.getElementById("emailErro").style.display = "block";
          btn.disabled = false; btn.textContent = "‚úÖ Finalizar Cadastro";
          return;
        } else {
          document.getElementById("emailErro").style.display = "none";
        }
      }catch(err){
        alert("‚ùå Erro ao verificar e-mail existente.\n" + (err?.message || err));
        btn.disabled = false; btn.textContent = "‚úÖ Finalizar Cadastro";
        return;
      }

      // Confere senhas
      const senha = document.getElementById("senha").value;
      const confirma = document.getElementById("confirmaSenha").value;
      if(senha !== confirma){
        alert("‚ùå As senhas n√£o coincidem!");
        btn.disabled = false; btn.textContent = "‚úÖ Finalizar Cadastro";
        return;
      }

      // Foto base64 (cuidado com tamanho)
      let fotoBase64 = "";
      try{
        const file = fotoInput?.files?.[0];
        if(file){
          if (file.size > 400 * 1024) {
            const continuar = confirm("‚ö†Ô∏è A foto √© grande (>400KB) e pode falhar ao salvar. Deseja continuar?");
            if(!continuar){
              btn.disabled = false; btn.textContent = "‚úÖ Finalizar Cadastro";
              return;
            }
          }
          fotoBase64 = await new Promise(resolve=>{
            const r = new FileReader();
            r.onload = ev => resolve(ev.target.result);
            r.readAsDataURL(file);
          });
        }
      }catch(err){
        console.warn("[Cadastro] Erro ao ler foto:", err);
      }

      const novoCadastro = {
        nome: document.getElementById("nome").value.trim(),
        apelido: document.getElementById("apelido").value.trim(),
        sexo: document.getElementById("sexo").value,
        telefone: document.getElementById("telefone").value.trim(),
        email,
        cep: document.getElementById("cep").value.trim(),
        rua: document.getElementById("rua").value.trim(),
        numero: document.getElementById("numero").value.trim(),
        complemento: document.getElementById("complemento").value.trim(),
        bairro: document.getElementById("bairro").value.trim(),
        cidade: document.getElementById("cidade").value.trim(),
        estado: document.getElementById("estado").value.trim(),
        visita: document.getElementById("visita").value,
        maps: document.getElementById("maps").value.trim(),
        senha,
        foto: fotoBase64,
        createdAt: new Date().toISOString()
      };

      try{
        await db.collection("cadastrosUsuarios").add(novoCadastro);
        alert("‚úÖ Cadastro realizado com sucesso!");
        window.location.href = "index.html";
      }catch(err){
        console.error("[Cadastro] Erro ao salvar:", err);
        let msg = "‚ùå Erro ao salvar cadastro.";
        if (err?.code === "permission-denied") {
          msg += "\n‚Ä¢ Regras do Firestore est√£o bloqueando (permission-denied).";
        } else if (err?.code === "failed-precondition") {
          msg += "\n‚Ä¢ Verifique se o Firestore est√° habilitado no console.";
        } else if (err?.code === "resource-exhausted" || (err?.message||"").includes("maximum")) {
          msg += "\n‚Ä¢ Documento muito grande (poss√≠vel foto grande). Tente sem foto.";
        }
        alert(msg + (err?.message ? "\n\nDetalhes: " + err.message : ""));
      } finally {
        btn.disabled = false; btn.textContent = "‚úÖ Finalizar Cadastro";
      }
    });

    // Aviso √∫til se abrir via file://
    if (location.protocol === "file:") {
      console.warn("‚ö†Ô∏è Dica: execute em http(s) (ex.: Live Server/serve) para evitar bloqueios do navegador.");
    }
  </script>
</body>
</html>
