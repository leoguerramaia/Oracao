<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <title>Cadastro - Pedidos de Ora√ß√£o</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root{
      --bg:#fff7f2;
      --card:#ffffff;
      --text:#2c3e50;
      --muted:#6b7b8c;
      --primary:#b22222;
      --primary-hov:#800000;
      --accent:#ff4500;
      --ring:rgba(178,34,34,.35);
    }
    body{margin:0;font-family:system-ui, Arial, sans-serif;background:var(--bg);color:var(--text);}
    header{background:var(--primary);color:#ffd700;padding:20px;text-align:center;}
    header h1{margin:0;font-size:24px;}
    .container{max-width:720px;margin:32px auto;padding:0 16px;}
    .card{background:var(--card);border-radius:14px;padding:24px;box-shadow:0 12px 30px rgba(0,0,0,.08);}
    form{display:flex;flex-direction:column;gap:12px}
    label{font-weight:600;margin-top:8px}
    label .required{color:var(--primary);margin-left:4px}
    input, select, button{width:100%;padding:12px 14px;border-radius:10px;font-size:15px;border:1px solid #e1e5ea;outline:none;background:#fff;}
    input:focus, select:focus{border-color:var(--primary);box-shadow:0 0 0 4px var(--ring)}
    .erro{color:var(--primary);font-size:13px;display:none}
    .msg{color:var(--muted);font-size:13px;margin-top:-6px}
    .preview{font-size:14px;margin-top:6px}
    .preview a{color:var(--primary);text-decoration:none;display:flex;align-items:center;gap:6px}
    .preview img{width:20px;height:20px}
    .senha-container{position:relative;display:flex;align-items:center;}
    .senha-container input{width:100%;padding-right:40px;}
    .toggle-senha{position:absolute;right:10px;cursor:pointer;font-size:18px;color:var(--muted);}
    .obrigatorio{font-size:13px;color:var(--muted);margin-top:4px;}
    button{border:none;font-weight:700;cursor:pointer;transition:.3s}
    .btn-main{background:var(--primary);color:#fff}
    .btn-main:hover{background:var(--primary-hov)}
    .row{display:flex;gap:12px;flex-wrap:wrap}
    .row>div{flex:1;min-width:150px}
    .foto-upload{display:flex;flex-direction:column;align-items:center;gap:8px;margin-bottom:16px;}
    .foto-preview{width:100px;height:100px;border-radius:50%;border:2px solid var(--primary);object-fit:cover;display:none;}
  </style>
</head>
<body>
  <header><h1>üìù Cadastro</h1></header>
  <main class="container">
    <section class="card">
      <form id="formCadastro" action="javascript:void(0);">
        <label for="nome">Nome:<span class="required">*</span></label>
        <input type="text" id="nome" required>

        <label for="apelido">Como Gosta de Ser Chamado:</label>
        <input type="text" id="apelido">

        <label for="sexo">Sexo:<span class="required">*</span></label>
        <select id="sexo" required>
          <option value="">Selecione...</option>
          <option value="MASCULINO">Masculino</option>
          <option value="FEMININO">Feminino</option>
        </select>

        <label for="telefone">Telefone:<span class="required">*</span></label>
        <input type="tel" id="telefone" required>

        <label for="email">E-mail:<span class="required">*</span></label>
        <input type="email" id="email" required>
        <div id="emailErro" class="erro">‚ùå J√° existe um cadastro com este e-mail.</div>

        <label for="senha">Senha:<span class="required">*</span></label>
        <div class="senha-container">
          <input type="password" id="senha" required>
          <span class="toggle-senha" onclick="toggleSenha('senha', this)">üëÅÔ∏è</span>
        </div>

        <label for="confirmaSenha">Confirmar Senha:<span class="required">*</span></label>
        <div class="senha-container">
          <input type="password" id="confirmaSenha" required>
          <span class="toggle-senha" onclick="toggleSenha('confirmaSenha', this)">üëÅÔ∏è</span>
        </div>

        <button type="submit" class="btn-main" id="btnCadastrar">‚úÖ Finalizar Cadastro</button>
      </form>
    </section>
  </main>

  <!-- Firebase compat -->
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore-compat.js"></script>

  <script>
    // Config corrigido
    const firebaseConfig = {
      apiKey: "AIzaSyATVaYFF3Ho47Vc4bB0BOy7Q2NKLAqSHXQ",
      authDomain: "pedidosoracao-5226e.firebaseapp.com",
      projectId: "pedidosoracao-5226e",
      storageBucket: "pedidosoracao-5226e.appspot.com", // <-- corrigido
      messagingSenderId: "1036424775005",
      appId: "1:1036424775005:web:e07fb3c31ff94854c894b4",
      measurementId: "G-DP0CCC7BGC"
    };

    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();
    console.log("[Firestore] inicializado.");

    function toggleSenha(id, el){
      const input = document.getElementById(id);
      if(input.type === "password"){ input.type = "text"; el.textContent = "üôà"; }
      else{ input.type = "password"; el.textContent = "üëÅÔ∏è"; }
    }

    const form = document.getElementById("formCadastro");
    const btn = document.getElementById("btnCadastrar");

    form.addEventListener("submit", async (e)=>{
      e.preventDefault();

      btn.disabled = true; btn.textContent = "Salvando...";

      const email = document.getElementById("email").value.trim().toLowerCase();

      // Verifica duplicidade
      try {
        const snap = await db.collection("cadastrosUsuarios").where("email","==",email).get();
        if(!snap.empty){
          document.getElementById("emailErro").style.display = "block";
          btn.disabled = false; btn.textContent = "‚úÖ Finalizar Cadastro";
          return;
        } else {
          document.getElementById("emailErro").style.display = "none";
        }
      } catch(err) {
        console.error("[Erro verifica√ß√£o e-mail]", err);
      }

      const senha = document.getElementById("senha").value;
      const confirma = document.getElementById("confirmaSenha").value;
      if(senha !== confirma){
        alert("‚ùå As senhas n√£o coincidem!");
        btn.disabled = false; btn.textContent = "‚úÖ Finalizar Cadastro";
        return;
      }

      const novoCadastro = {
        nome: document.getElementById("nome").value.trim(),
        apelido: document.getElementById("apelido").value.trim(),
        sexo: document.getElementById("sexo").value,
        telefone: document.getElementById("telefone").value.trim(),
        email,
        senha,
        createdAt: new Date().toISOString()
      };

      // Log do objeto
      console.log("Novo cadastro a salvar:", JSON.stringify(novoCadastro, null, 2));

      try {
        await db.collection("cadastrosUsuarios").add(novoCadastro);
        alert("‚úÖ Cadastro realizado com sucesso!");
        window.location.href = "index.html";
      } catch(err) {
        console.error("[Erro salvar Firestore]", err);
        alert("‚ùå Erro ao salvar cadastro.\n" + (err?.message || err));
      } finally {
        btn.disabled = false; btn.textContent = "‚úÖ Finalizar Cadastro";
      }
    });
  </script>
</body>
</html>
