<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <title>Gerenciar Cadastros - Administra√ß√£o</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root{
      --bg:#fff7f2; --card:#ffffff; --text:#2c3e50; --muted:#6b7b8c;
      --primary:#b22222; --primary-hov:#800000;
      --accent:#ff4500; --accent-hov:#e03c00;
      --gold:#ffd700; --ring:rgba(178,34,34,.35);
      --ok:#2ecc71; --warn:#f39c12; --danger:#e74c3c;
    }

    *{box-sizing:border-box}
    body{
      margin:0; font-family:system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      background:var(--bg); color:var(--text); min-height:100vh; display:flex; flex-direction:column;
    }

    /* Cabe√ßalho (padr√£o index) */
    header{
      position:relative; background:var(--primary); color:var(--gold);
      padding:20px 16px; text-align:center; box-shadow:0 2px 10px rgba(0,0,0,.15);
      text-shadow:0 0 6px rgba(255,215,0,.6);
    }
    header h1{margin:0;font-size:24px;letter-spacing:.5px}

    /* Barra do usu√°rio */
    .userbar{position:absolute;right:16px;top:50%;transform:translateY(-50%);display:none;align-items:center;gap:12px;color:#fff}
    .user-meta{ text-align:right; line-height:1.2; font-size:13px; color:#fff }
    .user-meta strong{display:block; color:#fff}
    .badge{display:inline-block;font-size:11px;padding:2px 8px;border-radius:999px;background:#ffffff22;color:#fff;margin-top:4px}
    .logout{background:var(--accent);color:#fff;border:none;padding:8px 12px;border-radius:8px;cursor:pointer;font-weight:700;transition:.25s;box-shadow:0 6px 16px rgba(0,0,0,.12)}
    .logout:hover{background:var(--accent-hov)}

    /* Container */
    .container{max-width:1100px;width:100%;margin:28px auto;padding:0 16px;flex:1;display:flex;flex-direction:column;gap:16px}
    .card{background:var(--card);border-radius:14px;padding:20px;box-shadow:0 12px 30px rgba(0,0,0,.08);border:1px solid rgba(0,0,0,.05)}
    .card h2{margin:0 0 6px 0;color:var(--primary);font-size:22px}
    .subtitle{color:var(--muted);margin:0 0 12px}

    /* Top controls */
    .controls{display:flex;flex-wrap:wrap;gap:10px;align-items:center}
    .controls input, .controls select{
      padding:10px 12px;border-radius:10px;border:1px solid #e1e5ea;background:#fff;outline:none;
    }
    .controls input:focus, .controls select:focus{border-color:var(--primary);box-shadow:0 0 0 4px var(--ring)}
    .btn{appearance:none;border:none;border-radius:10px;padding:10px 14px;cursor:pointer;font-weight:800;letter-spacing:.3px;transition:.25s;box-shadow:0 6px 16px rgba(0,0,0,.08)}
    .btn:active{transform:translateY(1px)}
    .btn-main{background:var(--primary);color:#fff}.btn-main:hover{background:var(--primary-hov)}
    .btn-outline{background:#fff;color:var(--accent);border:1px solid #e1e5ea}.btn-outline:hover{background:#f7f9fb;color:var(--accent-hov)}

    /* Tabela responsiva */
    .table-wrap{overflow:auto;border:1px solid #eaeaea;border-radius:12px;background:#fff}
    table{border-collapse:separate;border-spacing:0;width:100%;min-width:960px}
    thead th{
      position:sticky; top:0; background:#fafafa; color:#444; font-weight:700;
      text-align:left; padding:12px; border-bottom:1px solid #eee; z-index:1;
    }
    tbody td{padding:10px 12px;border-bottom:1px solid #f0f0f0;vertical-align:middle}
    tbody tr:hover{background:#fffaf4}
    td.actions{white-space:nowrap}

    /* Inputs dentro da tabela (edi√ß√£o) */
    .tbl-input, .tbl-select{
      width:100%; padding:8px 10px; border-radius:8px; border:1px solid #e1e5ea; background:#fff; font-size:14px;
    }
    .tbl-input:focus, .tbl-select:focus{border-color:var(--primary);box-shadow:0 0 0 3px var(--ring)}
    .chip{display:inline-block;padding:4px 8px;border-radius:999px;font-size:12px}
    .chip-admin{background:#ffe8e8;color:#b22222;border:1px solid #f2b3b3}
    .chip-user{background:#e8f7ff;color:#1565c0;border:1px solid #b6def8}

    .btn-sm{padding:8px 10px;border-radius:8px;font-weight:700}
    .btn-ok{background:var(--ok);color:#fff}
    .btn-ok:hover{filter:brightness(.9)}
    .btn-warn{background:var(--warn);color:#fff}
    .btn-warn:hover{filter:brightness(.95)}
    .btn-danger{background:var(--danger);color:#fff}
    .btn-danger:hover{filter:brightness(.95)}

    footer{text-align:center;padding:14px 10px;font-size:13px;color:#6b7b8c}
    @media (max-width:640px){
      header h1{font-size:20px}
      .controls{flex-direction:column;align-items:stretch}
      .btn{width:100%}
    }
  </style>
</head>
<body>
  <header>
    <h1>üë• Gerenciar Cadastros</h1>
    <div class="userbar" id="userBar">
      <div class="user-meta" id="userMeta"></div>
      <button class="logout" id="logoutBtn">Sair</button>
    </div>
  </header>

  <main class="container">
    <section class="card">
      <h2>Cadastros de Usu√°rios</h2>
      <p class="subtitle">Visualize, edite e exclua usu√°rios. A senha n√£o √© exibida aqui.</p>

      <div class="controls">
        <input id="filtro" type="text" placeholder="Filtrar por nome ou e-mail‚Ä¶" />
        <select id="filtroTipo">
          <option value="">Todos os perfis</option>
          <option value="Administrador">Administradores</option>
          <option value="Usu√°rio">Usu√°rios</option>
        </select>
        <button class="btn btn-outline" onclick="location.href='admin.html'">‚¨ÖÔ∏è Voltar ao Painel</button>
        <button class="btn btn-main" onclick="location.href='index.html'">üè† P√°gina Inicial</button>
      </div>
    </section>

    <section class="card">
      <div class="table-wrap">
        <table id="tabela">
          <thead>
            <tr>
              <th>Nome</th>
              <th>E-mail</th>
              <th>Telefone</th>
              <th>Sexo</th>
              <th>CEP</th>
              <th>Rua</th>
              <th>Bairro</th>
              <th>N¬∫</th>
              <th>Compl.</th>
              <th>Refer√™ncia</th>
              <th>Visita</th>
              <th>Maps (URL)</th>
              <th>Tipo</th>
              <th class="actions">A√ß√µes</th>
            </tr>
          </thead>
          <tbody id="tbody"></tbody>
        </table>
      </div>
    </section>
  </main>

  <footer>Minist√©rio PGM ‚Ä¢ Pedidos de Ora√ß√£o</footer>

  <script>
    /* ========= Helpers de sess√£o/perfil ========= */
    const ADMINS_FIXOS = ["leoguerramaia@gmail.com","admin@admin.com.br","admin"];
    const getUser      = () => { try { return JSON.parse(localStorage.getItem("usuarioLogado")); } catch { return null; } };
    const getCadastros = () => { try { return JSON.parse(localStorage.getItem("cadastrosUsuarios")) || []; } catch { return []; } };
    const setCadastros = (arr) => localStorage.setItem("cadastrosUsuarios", JSON.stringify(arr));
    const firstName    = n => (n||"Usu√°rio").trim().split(" ")[0];
    const isAdmin = (u, cads) => {
      if(!u) return false;
      const email=(u.email||"").toLowerCase();
      if(ADMINS_FIXOS.includes(email)) return true;
      const reg=(cads||[]).find(x => (x.email||"").toLowerCase() === email);
      return !!reg && (reg.fixo===true || reg.isAdmin===true || reg.tipoUsuario==="Administrador");
    };

    /* ========= Estado / Renderiza√ß√£o ========= */
    let cadastros = [];
    let editIndex = -1; // linha em edi√ß√£o

    function renderTabela(){
      const tbody = document.getElementById("tbody");
      const filtro = (document.getElementById("filtro").value || "").toLowerCase();
      const filtroTipo = document.getElementById("filtroTipo").value;

      const linhas = cadastros
        .map((u, idx) => ({u, idx}))
        .filter(({u}) => {
          const alvo = `${u.nome||""} ${(u.email||"")}`.toLowerCase();
          const passaTexto = !filtro || alvo.includes(filtro);
          const tipo = u.tipoUsuario || (u.isAdmin ? "Administrador" : "Usu√°rio");
          const passaTipo  = !filtroTipo || filtroTipo === tipo;
          return passaTexto && passaTipo;
        })
        .map(({u, idx}) => {
          const tipo = u.tipoUsuario || (u.isAdmin ? "Administrador" : "Usu√°rio");
          const chip = tipo === "Administrador"
            ? `<span class="chip chip-admin">Administrador</span>`
            : `<span class="chip chip-user">Usu√°rio</span>`;

          if(editIndex === idx){
            // Linha em modo edi√ß√£o
            return `
              <tr data-i="${idx}">
                <td><input class="tbl-input" value="${escapeHtml(u.nome||"")}" id="e-nome-${idx}"></td>
                <td><input class="tbl-input" value="${escapeHtml(u.email||"")}" id="e-email-${idx}"></td>
                <td><input class="tbl-input" value="${escapePhone(u.telefone||"")}" id="e-telefone-${idx}"></td>
                <td>
                  <select class="tbl-select" id="e-sexo-${idx}">
                    ${opt(u.sexo,"MASCULINO")} ${opt(u.sexo,"FEMININO")}
                  </select>
                </td>
                <td><input class="tbl-input" value="${escapeHtml(u.cep||"")}" id="e-cep-${idx}"></td>
                <td><input class="tbl-input" value="${escapeHtml(u.rua||"")}" id="e-rua-${idx}"></td>
                <td><input class="tbl-input" value="${escapeHtml(u.bairro||"")}" id="e-bairro-${idx}"></td>
                <td><input class="tbl-input" value="${escapeHtml(u.numero||"")}" id="e-numero-${idx}"></td>
                <td><input class="tbl-input" value="${escapeHtml(u.complemento||"")}" id="e-complemento-${idx}"></td>
                <td><input class="tbl-input" value="${escapeHtml(u.referencia||"")}" id="e-referencia-${idx}"></td>
                <td>
                  <select class="tbl-select" id="e-visita-${idx}">
                    ${opt(u.visita,"SIM")} ${opt(u.visita,"N√ÉO")}
                  </select>
                </td>
                <td><input class="tbl-input" value="${escapeHtml(u.maps||"")}" id="e-maps-${idx}"></td>
                <td>
                  <select class="tbl-select" id="e-tipo-${idx}">
                    ${opt(tipo,"Usu√°rio")} ${opt(tipo,"Administrador")}
                  </select>
                </td>
                <td class="actions">
                  <button class="btn btn-sm btn-ok" onclick="salvar(${idx})">üíæ Salvar</button>
                  <button class="btn btn-sm btn-outline" onclick="cancelar()">‚Ü©Ô∏è Cancelar</button>
                </td>
              </tr>
            `;
          } else {
            // Linha normal
            return `
              <tr data-i="${idx}">
                <td>${escapeHtml(u.nome||"")}</td>
                <td>${escapeHtml(u.email||"")}</td>
                <td>${escapeHtml(u.telefone||"")}</td>
                <td>${escapeHtml(u.sexo||"")}</td>
                <td>${escapeHtml(u.cep||"")}</td>
                <td>${escapeHtml(u.rua||"")}</td>
                <td>${escapeHtml(u.bairro||"")}</td>
                <td>${escapeHtml(u.numero||"")}</td>
                <td>${escapeHtml(u.complemento||"")}</td>
                <td>${escapeHtml(u.referencia||"")}</td>
                <td>${escapeHtml(u.visita||"")}</td>
                <td>${linkMaps(u.maps)}</td>
                <td>${chip}</td>
                <td class="actions">
                  <button class="btn btn-sm btn-warn" onclick="editar(${idx})">‚úèÔ∏è Editar</button>
                  <button class="btn btn-sm btn-danger" onclick="excluirUsuario(${idx})">üóëÔ∏è Excluir</button>
                </td>
              </tr>
            `;
          }
        })
        .join("");

      tbody.innerHTML = linhas || `<tr><td colspan="14" style="text-align:center;color:#888;padding:18px">Nenhum registro encontrado.</td></tr>`;
    }

    // Utilit√°rios
    const opt = (val, txt) => `<option value="${txt}" ${String(val||"")===txt?"selected":""}>${txt}</option>`;
    const escapeHtml = (s) => String(s).replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]));
    const escapePhone = (s) => String(s).replace(/[^\d+()-\s]/g,"");
    const linkMaps = (url) => {
      if(!url) return "";
      const safe = escapeHtml(url);
      return `<a href="${safe}" target="_blank" rel="noopener">Abrir</a>`;
    };

    function editar(i){ editIndex = i; renderTabela(); }
    function cancelar(){ editIndex = -1; renderTabela(); }

    function salvar(i){
      const original = cadastros[i];
      if(!original) return;

      // ler valores da linha
      const get = id => document.getElementById(id)?.value || "";
      const novo = {
        ...original, // preserva senha e flags n√£o editadas
        nome: get(`e-nome-${i}`).trim(),
        email: get(`e-email-${i}`).trim().toLowerCase(),
        telefone: get(`e-telefone-${i}`).trim(),
        sexo: get(`e-sexo-${i}`),
        cep: get(`e-cep-${i}`).trim(),
        rua: get(`e-rua-${i}`).trim(),
        bairro: get(`e-bairro-${i}`).trim(),
        numero: get(`e-numero-${i}`).trim(),
        complemento: get(`e-complemento-${i}`).trim(),
        referencia: get(`e-referencia-${i}`).trim(),
        visita: get(`e-visita-${i}`),
        maps: get(`e-maps-${i}`).trim(),
        tipoUsuario: get(`e-tipo-${i}`) || "Usu√°rio",
      };
      novo.isAdmin = (novo.tipoUsuario === "Administrador") || !!original.isAdmin; // mant√©m se j√° era admin por flag
      // mant√©m 'fixo' como veio (n√£o editamos essa prote√ß√£o aqui)

      // valida√ß√µes
      if(!novo.nome){ alert("Informe o nome."); return; }
      if(!novo.email){ alert("Informe o e-mail."); return; }
      // e-mail √∫nico
      const existe = cadastros.some((u,idx) => idx!==i && (u.email||"").toLowerCase() === novo.email);
      if(existe){ alert("J√° existe um usu√°rio com este e-mail."); return; }

      // aplica e salva
      cadastros[i] = novo;
      setCadastros(cadastros);

      // se for o usu√°rio logado, atualiza sess√£o
      const atual = getUser();
      if(atual && (atual.email||"").toLowerCase() === (original.email||"").toLowerCase()){
        localStorage.setItem("usuarioLogado", JSON.stringify({
          ...atual,
          ...novo,
          senha: atual.senha // nunca alterar aqui
        }));
      }

      editIndex = -1;
      renderTabela();
    }

    function excluirUsuario(i){
      const alvo = cadastros[i];
      if(!alvo) return;

      const email = (alvo.email||"").toLowerCase();
      if(alvo.fixo === true || ADMINS_FIXOS.includes(email)){
        alert("Este usu√°rio administrador fixo n√£o pode ser exclu√≠do.");
        return;
      }

      if(!confirm(`Excluir o usu√°rio "${alvo.nome}" (${alvo.email})?`)) return;

      cadastros.splice(i,1);
      setCadastros(cadastros);

      // se excluiu o pr√≥prio usu√°rio, encerra sess√£o
      const atual = getUser();
      if(atual && (atual.email||"").toLowerCase() === email){
        localStorage.removeItem("usuarioLogado");
        alert("Seu usu√°rio foi exclu√≠do. Voc√™ realizou o logoff.");
        location.href = "index.html";
        return;
      }

      renderTabela();
    }

    /* ========= Inicializa√ß√£o / prote√ß√£o de rota ========= */
    document.addEventListener("DOMContentLoaded", () => {
      const user = getUser();
      if(!user){
        alert("‚ö†Ô∏è Voc√™ precisa estar logado para acessar esta p√°gina.");
        location.replace("login.html");
        return;
      }
      cadastros = getCadastros();
      if(!isAdmin(user, cadastros)){
        alert("‚õî Acesso restrito a administradores.");
        location.replace("usuariologado.html");
        return;
      }

      // Preenche barra do usu√°rio
      const bar = document.getElementById("userBar");
      const meta = document.getElementById("userMeta");
      meta.innerHTML = `
        <strong>${firstName(user.nome)}</strong>
        <span>${user.email || ""}</span>
        <span class="badge">Administrador</span>
      `;
      bar.style.display = "flex";

      // Logout
      document.getElementById("logoutBtn").addEventListener("click", () => {
        localStorage.removeItem("usuarioLogado");
        alert("Voc√™ realizou o logoff.");
        location.href = "index.html";
      });

      // Filtro
      document.getElementById("filtro").addEventListener("input", renderTabela);
      document.getElementById("filtroTipo").addEventListener("change", renderTabela);

      // Render inicial
      renderTabela();
    });
  </script>
</body>
</html>
